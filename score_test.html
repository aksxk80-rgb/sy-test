<script>
const CSV_URL =
  "https://docs.google.com/spreadsheets/d/1CQOwFcg-lpUQ77ot8-6FhG4D6b4zxd6yo-bkpHjHetU/export?format=csv&gid=914454642";

async function loadScoreboard() {
  const statusEl = document.getElementById("status");
  const boardEl = document.getElementById("board");

  try {
    const res = await fetch(CSV_URL);
    const text = await res.text();

    // CSV 정리: 줄바꿈 통일 + BOM 제거 + 빈 줄 제거 + 쉼표만 있는 줄 제거
    let rows = text
      .replace(/\r\n/g, "\n")
      .replace(/\r/g, "\n")
      .split("\n")
      .map(r => r.replace(/^\uFEFF/, "").trim())
      .filter(r => r.replace(/,/g, "").trim() !== "");

    console.log("rows:", rows);

    // 헤더
    const header = rows[0].split(",");

    // 컬럼 자동 감지
    const rankIdx = header.findIndex(h => h.includes("팀 순위"));
    const nameIdx = header.findIndex(h => h.includes("팀명"));
    const totalIdx = header.findIndex(h => h.includes("총점"));

    if (rankIdx < 0 || nameIdx < 0 || totalIdx < 0) {
      throw new Error("컬럼명을 찾을 수 없습니다.");
    }

    // 데이터
    const dataRows = rows.slice(1).map(r => r.split(","));

    let items = dataRows
      .map(cols => {
        const rank = cols[rankIdx]?.trim();
        const name = cols[nameIdx]?.trim();
        const total = cols[totalIdx]?.trim();
        if (!rank || !name) return null;
        return {
          rank: Number(rank),
          displayName: name,
          teamKeyName: name,
          score: total,
          total
        };
      })
      .filter(Boolean)
      .sort((a, b) => a.rank - b.rank);

    boardEl.innerHTML = "";
    statusEl.textContent = "";

    if (!items.length) {
      statusEl.textContent = "표시할 데이터가 없습니다.";
      return;
    }

    // 카드 렌더링
    items.forEach(item => {
      const card = document.createElement("div");
      card.className = "card";

      const left = document.createElement("div");
      left.className = "card-left";

      const badge = document.createElement("div");
      badge.className = "rank-badge";
      if (item.rank === 1) badge.classList.add("rank-1");
      else if (item.rank === 2) badge.classList.add("rank-2");
      else if (item.rank === 3) badge.classList.add("rank-3");
      badge.textContent = item.rank + "위";

      const info = document.createElement("div");
      const nameEl = document.createElement("div");
      nameEl.className = "team-name";
      nameEl.textContent = item.displayName;

      const subEl = document.createElement("div");
      subEl.className = "team-sub";
      subEl.textContent = "팀ID: " + item.teamKeyName;

      info.appendChild(nameEl);
      info.appendChild(subEl);
      left.appendChild(badge);
      left.appendChild(info);

      const right = document.createElement("div");
      right.className = "card-right";

      const scoreEl = document.createElement("div");
      scoreEl.className = "score";
      scoreEl.textContent = item.score;

      const scoreLabel = document.createElement("div");
      scoreLabel.className = "score-label";
      scoreLabel.textContent = "팀 점수";

      const totalEl = document.createElement("div");
      totalEl.className = "total-score";
      totalEl.textContent = "총점: " + item.total;

      right.appendChild(scoreEl);
      right.appendChild(scoreLabel);
      right.appendChild(totalEl);

      card.appendChild(left);
      card.appendChild(right);
      boardEl.appendChild(card);
    });
  } catch (err) {
    statusEl.textContent = "점수판을 불러오는 중 오류가 발생했습니다.";
  }
}

loadScoreboard();
</script>
