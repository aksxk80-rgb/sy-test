<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>메리클라인 예선 스코어보드</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0b1020;
      color: #f5f5f5;
      margin: 0;
      padding: 20px;
    }
    h1 { margin-bottom: 4px; }
    .subtitle { color: #9ca3af; margin-bottom: 20px; }
    .board { display: flex; flex-wrap: wrap; gap: 12px; }
    .card {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      padding: 12px;
      width: 160px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .card:hover { background: rgba(255,255,255,0.15); }
    .rank { font-size: 1.2rem; font-weight: bold; color: #fbbf24; }
    .name { margin-top: 4px; font-weight: 500; }
    .score { margin-top: 2px; color: #93c5fd; }
    .loading { margin-top: 40px; text-align: center; color: #9ca3af; }
  </style>
</head>
<body>

  <h1>메리클라인 예선 스코어보드</h1>
  <div class="subtitle">실시간 팀 순위! · 스프레드시트 기반 자동 업데이트</div>
  <div id="status" class="loading">데이터 불러오는 중...</div>
  <div id="board" class="board"></div>

  <script>
    const CSV_URL =
      "https://docs.google.com/spreadsheets/d/1BgeBpjbcBa3b-k9rBhpygxIYKOgNSH81Z71p1a-D1N8/export?format=csv&gid=914454642";

    async function loadScoreboard() {
      const statusEl = document.getElementById("status");
      const boardEl = document.getElementById("board");

      try {
        const res = await fetch(CSV_URL);
        const text = await res.text();

        const rows = text
          .replace(/\r\n/g, "\n")
          .replace(/\r/g, "\n")
          .split("\n")
          .map(r => r.trim())
          .filter(r => r !== "")
          .map(r => r.split(",").map(c => c.replace(/"/g, "").trim()));

        console.log("전체 행 수:", rows.length);

        // 헤더 행 자동 탐색 ("팀 순위" 포함된 줄 찾기)
        const headerRowIndex = rows.findIndex(r => r.includes("팀 순위") && r.includes("팀명"));
        if (headerRowIndex === -1) {
          statusEl.innerText = "헤더를 찾을 수 없습니다. 첫 줄: " + rows[0].join(",");
          return;
        }
        const header = rows[headerRowIndex];
        const dataRows = rows.slice(headerRowIndex + 1);

        console.log("헤더:", header);

        const rankIdx = header.findIndex(h => h.includes("팀 순위"));
        const nameIdx = header.findIndex(h => h.includes("팀명"));
        const totalIdx = header.findIndex(h => h.includes("총점"));

        if (rankIdx < 0 || nameIdx < 0 || totalIdx < 0) {
          statusEl.innerText = "컬럼명을 찾을 수 없습니다. 실제 헤더: " + header.join(",");
          return;
        }

        let items = dataRows
          .map(cols => {
            const rank = cols[rankIdx];
            const name = cols[nameIdx];
            const total = cols[totalIdx];
            if (!rank || !name) return null;
            return {
              rank: Number(rank),
              displayName: name,
              teamKeyName: name,
              score: total,
              total
            };
          })
          .filter(Boolean)
          .sort((a, b) => a.rank - b.rank);

        console.log("팀 수:", items.length);

        boardEl.innerHTML = "";
        statusEl.textContent = "";

        if (!items.length) {
          statusEl.textContent = "표시할 데이터가 없습니다.";
          return;
        }

        items.forEach(item => {
          const card = document.createElement("div");
          card.className = "card";

          card.onclick = () => {
            window.location.href =
              `/sy-test/2026/merryclimb_detail.html?team=${encodeURIComponent(item.teamKeyName)}`;
          };

          card.innerHTML = `
            <div class="rank">${item.rank}</div>
            <div class="name">${item.displayName}</div>
            <div class="score">${item.total}</div>
          `;
          boardEl.appendChild(card);
        });

      } catch (err) {
        statusEl.textContent = "데이터 로딩 실패: " + err.message;
        console.error("에러 발생:", err);
      }
    }

    loadScoreboard();
  </script>

</body>
</html>
